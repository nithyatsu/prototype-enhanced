# ---------------------------------------------------------------
# Architecture Diagram Generator
# ---------------------------------------------------------------
# Spins up a Kind cluster, installs Radius with custom images,
# runs `rad app graph` to extract resources & connections from
# app.bicep, generates a Mermaid diagram with GitHub styling,
# and updates README.md with the interactive graph.
#
# Trigger: Push to main, every 2 hours, or manual dispatch
# Based on: workflow-spec.md
# ---------------------------------------------------------------

name: Generate Architecture Diagram

on:
  push:
    branches: [main]
  schedule:
    # Every 2 hours
    - cron: "0 */2 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-diagram:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------------
      # Step 0: Checkout
      # -------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------------------------------
      # Step 1: Spin up a Kind cluster
      # -------------------------------------------------------
      - name: Create Kind cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: radius-graph
          wait: 120s

      - name: Verify cluster is ready
        run: kubectl cluster-info && kubectl get nodes

      # -------------------------------------------------------
      # Step 2: Install Radius CLI & install into cluster
      # -------------------------------------------------------
      - name: Install Radius CLI
        run: |
          curl -fsSL "https://raw.githubusercontent.com/radius-project/radius/main/deploy/install.sh" | /bin/bash
          rad version

      - name: Install Radius with custom images
        run: |
          rad install kubernetes \
            --set rp.image=ghcr.io/nithyatsu/applications-rp,rp.tag=latest \
            --set dynamicrp.image=ghcr.io/nithyatsu/dynamic-rp,dynamicrp.tag=latest \
            --set controller.image=ghcr.io/nithyatsu/controller,controller.tag=latest \
            --set ucp.image=ghcr.io/nithyatsu/ucpd,ucp.tag=latest \
            --set bicep.image=ghcr.io/nithyatsu/bicep,bicep.tag=latest

      - name: Configure Radius workspace and environment
        run: |
          rad workspace create kubernetes
          rad group create kind-radius
          rad group switch kind-radius
          # Use default namespace for the environment
          rad env create kind-radius --namespace default
          rad env switch kind-radius

      # -------------------------------------------------------
      # Debug: Describe applications-rp pod
      # -------------------------------------------------------
      - name: Describe applications-rp pod
        run: |
          echo "=== Radius pods ==="
          kubectl get pods -n radius-system
          echo ""
          echo "=== Describe applications-rp ==="
          kubectl describe pod -l app.kubernetes.io/name=applications-rp -n radius-system
          echo ""
          echo "=== applications-rp logs ==="
          kubectl logs -l app.kubernetes.io/name=applications-rp -n radius-system --tail=50 || true

      # -------------------------------------------------------
      # Step 3: Verify file path & generate the application graph
      # -------------------------------------------------------
      - name: Verify app.bicep exists
        run: |
          echo "GITHUB_WORKSPACE = ${{ github.workspace }}"
          echo "pwd = $(pwd)"
          ls -la "${{ github.workspace }}/"
          echo ""
          echo "app.bicep location:"
          find "${{ github.workspace }}" -name "app.bicep" -type f
          test -f "${{ github.workspace }}/app.bicep" && echo "✅ app.bicep found" || echo "❌ app.bicep NOT found"

      - name: Run rad app graph
        run: |
          rad app graph "${{ github.workspace }}/app.bicep" > /tmp/rad-graph-output.txt
          echo "--- rad app graph output ---"
          cat /tmp/rad-graph-output.txt

      # -------------------------------------------------------
      # Steps 4-5: Build Mermaid graph & update README
      # -------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Generate Mermaid diagram and update README
        env:
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          REPO_BRANCH: ${{ github.ref_name }}
          RAD_GRAPH_OUTPUT: /tmp/rad-graph-output.txt
        run: python scripts/generate_architecture.py

      # -------------------------------------------------------
      # Step 7: Commit and push (only if changed)
      # -------------------------------------------------------
      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          # Only commit if there are changes
          git diff --staged --quiet || git commit -m "docs: update architecture diagram [automated]"
          git push
